#!/bin/bash
################################################################################
# PRESTASHOP ANTIMALWARE PROTECTION SCRIPT
# Protección automática contra Credit Card Stealer
# 
# Versión: 1.0
# Fecha: 6 de febrero de 2026
# 
# Este script detecta y elimina automáticamente malware de tipo
# "Credit Card Stealer" que infecta archivos core de PrestaShop
################################################################################

# === CONFIGURACIÓN - EDITA ESTOS VALORES ===

# Ruta absoluta a la instalación de PrestaShop
PRESTASHOP_ROOT="/home/USUARIO/public_html"

# URLs de archivos limpios (versión oficial de PrestaShop)
# IMPORTANTE: Deben terminar en .txt (ver README)
CLEAN_CONTROLLER_URL="https://TUDOMINIO.com/clean_files/Controller.php.txt"
CLEAN_FRONTCONTROLLER_URL="https://TUDOMINIO.com/clean_files/FrontController.php.txt"
CLEAN_ADMINLOGIN_URL="https://TUDOMINIO.com/clean_files/AdminLoginController.php.txt"

# Configuración de notificaciones
EMAIL_ALERTS="admin@TUDOMINIO.com"
SEND_EMAIL_ON_INFECTION="yes"  # yes/no
SEND_EMAIL_ON_CLEAN="no"       # yes/no

# Configuración de logs
LOG_FILE="/home/USUARIO/logs/prestashop_antimalware.log"
LOG_MAX_SIZE=10485760  # 10MB en bytes

# Directorio para backups de archivos infectados
BACKUP_DIR="/home/USUARIO/var/backups/infected"

# Directorio temporal para descargas
TEMP_DIR="/home/USUARIO/public_html/var/files"

# Configuración de seguridad
VERIFY_SSL="yes"  # yes/no - Verificar certificados SSL en descargas

# === FIN DE CONFIGURACIÓN ===

################################################################################
# NO EDITAR DEBAJO DE ESTA LÍNEA (a menos que sepas lo que haces)
################################################################################

# Colores para output (si se ejecuta manualmente)
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Contadores
INFECTED_FILES=0
RESTORED_FILES=0
DELETED_MALWARE=0

# Flag para saber si hubo infección
INFECTION_DETECTED=0

################################################################################
# FUNCIÓN: Inicializar log
################################################################################
init_log() {
    # Crear directorio de log si no existe
    LOG_DIR=$(dirname "$LOG_FILE")
    if [ ! -d "$LOG_DIR" ]; then
        mkdir -p "$LOG_DIR" 2>/dev/null
    fi
    
    # Rotar log si es muy grande
    if [ -f "$LOG_FILE" ] && [ $(stat -f%z "$LOG_FILE" 2>/dev/null || stat -c%s "$LOG_FILE" 2>/dev/null) -gt $LOG_MAX_SIZE ]; then
        mv "$LOG_FILE" "$LOG_FILE.old"
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] Log rotado por tamaño" > "$LOG_FILE"
    fi
    
    # Crear backup dir si no existe
    if [ ! -d "$BACKUP_DIR" ]; then
        mkdir -p "$BACKUP_DIR" 2>/dev/null
    fi
    
    # Crear temp dir si no existe
    if [ ! -d "$TEMP_DIR" ]; then
        mkdir -p "$TEMP_DIR" 2>/dev/null
    fi
}

################################################################################
# FUNCIÓN: Escribir en log
################################################################################
log_message() {
    local level=$1
    shift
    local message="$@"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [$level] $message" >> "$LOG_FILE"
}

################################################################################
# FUNCIÓN: Detectar malware en archivo PHP
################################################################################
detect_malware_in_php() {
    local file=$1
    local patterns=(
        "jschecks"
        "order_llx"
        "aHR0cHM6Ly8xMDYuMTQuNDAuMjAw"
        "aHR0cHM6Ly80Ny4xMDIuMjA4LjY1"
        "statistics_hash_commented_Virus_infection"
        "FoAI8"
        "106.14.40.200"
        "47.102.208.65"
    )
    
    for pattern in "${patterns[@]}"; do
        if grep -q "$pattern" "$file" 2>/dev/null; then
            return 0  # Malware detectado
        fi
    done
    
    return 1  # Archivo limpio
}

################################################################################
# FUNCIÓN: Backup de archivo infectado
################################################################################
backup_infected_file() {
    local file=$1
    local filename=$(basename "$file")
    local timestamp=$(date '+%Y%m%d_%H%M%S')
    local backup_path="$BACKUP_DIR/${filename}.infected.${timestamp}"
    
    cp "$file" "$backup_path" 2>/dev/null
    if [ $? -eq 0 ]; then
        log_message "INFO" "Backup creado: $backup_path"
        echo -e "${GREEN}✓${NC} Backup guardado: $backup_path"
        return 0
    else
        log_message "ERROR" "No se pudo crear backup de: $file"
        return 1
    fi
}

################################################################################
# FUNCIÓN: Restaurar archivo desde URL
################################################################################
restore_file_from_url() {
    local url=$1
    local destination=$2
    local filename=$(basename "$destination")
    
    echo -e "${YELLOW}↻${NC} Descargando archivo limpio: $filename"
    log_message "INFO" "Descargando desde: $url"
    
    # Preparar opciones de curl
    local curl_opts="-s -f -L"
    if [ "$VERIFY_SSL" = "no" ]; then
        curl_opts="$curl_opts -k"
    fi
    
    # Descargar a archivo temporal
    local tmp_file="$TEMP_DIR/ps_clean_$(date +%s).php"
    
    # Ejecutar curl y capturar exit code inmediatamente
    curl $curl_opts -o "$tmp_file" "$url"
    local curl_exit=$?
    
    if [ $curl_exit -eq 0 ] && [ -f "$tmp_file" ]; then
        # Verificar que es un archivo PHP válido (buscar en primeras 20 líneas)
        if head -20 "$tmp_file" | grep -q "<?php"; then
            # Hacer backup del infectado
            backup_infected_file "$destination"
            
            # Reemplazar con archivo limpio
            cp "$tmp_file" "$destination"
            chmod 644 "$destination"
            rm -f "$tmp_file"
            
            log_message "SUCCESS" "Archivo restaurado: $filename"
            echo -e "${GREEN}✓${NC} Restaurado exitosamente: $filename"
            RESTORED_FILES=$((RESTORED_FILES + 1))
            return 0
        else
            log_message "ERROR" "Archivo descargado no es PHP válido: $url"
            echo -e "${RED}✗${NC} Error: Archivo descargado inválido"
            rm -f "$tmp_file"
            return 1
        fi
    else
        log_message "ERROR" "Fallo al descargar: $url"
        echo -e "${RED}✗${NC} Error al descargar archivo limpio"
        rm -f "$tmp_file"
        return 1
    fi
}

################################################################################
# FUNCIÓN: Verificar y restaurar archivo PHP
################################################################################
check_and_restore_php_file() {
    local file_path=$1
    local clean_url=$2
    local file_name=$(basename "$file_path")
    
    if [ ! -f "$file_path" ]; then
        log_message "WARNING" "Archivo no existe: $file_path"
        return 1
    fi
    
    if detect_malware_in_php "$file_path"; then
        echo -e "${RED}⚠${NC} INFECCIÓN DETECTADA: $file_name"
        log_message "ALERT" "Malware detectado en: $file_path"
        INFECTED_FILES=$((INFECTED_FILES + 1))
        INFECTION_DETECTED=1
        
        # Restaurar desde URL
        restore_file_from_url "$clean_url" "$file_path"
        return $?
    fi
    
    return 0
}

################################################################################
# FUNCIÓN: Detectar imagen falsa (malware disfrazado)
################################################################################
is_fake_image() {
    local file=$1
    local filename=$(basename "$file")
    
    # Verificar extensión de imagen
    if [[ ! "$filename" =~ \.(png|jpg|jpeg|gif|webp|svg)$ ]]; then
        return 1  # No es imagen
    fi
    
    # Método 1: Verificar tipo de archivo real
    local file_type=$(file -b "$file" 2>/dev/null)
    if echo "$file_type" | grep -qE "(ASCII|text|PHP|script)"; then
        log_message "ALERT" "Imagen falsa detectada (tipo: $file_type): $filename"
        return 0  # Es falsa
    fi
    
    # Método 2: Buscar patrones de código JavaScript/PHP
    if grep -qE "(var |function |<script|PHNjcmlwdD4|<?php|order_llx)" "$file" 2>/dev/null; then
        log_message "ALERT" "Imagen falsa detectada (contiene código): $filename"
        return 0  # Es falsa
    fi
    
    # Método 3: Verificar header de PNG si es .png
    if [[ "$filename" =~ \.png$ ]]; then
        local header=$(head -c 4 "$file" | od -An -tx1 | tr -d ' ')
        if [ "$header" != "89504e47" ]; then
            log_message "ALERT" "Imagen falsa detectada (header PNG inválido): $filename"
            return 0  # Es falsa
        fi
    fi
    
    # Método 4: Verificar header de JPEG si es .jpg/.jpeg
    if [[ "$filename" =~ \.(jpg|jpeg)$ ]]; then
        local header=$(head -c 2 "$file" | od -An -tx1 | tr -d ' ')
        if [ "$header" != "ffd8" ]; then
            log_message "ALERT" "Imagen falsa detectada (header JPEG inválido): $filename"
            return 0  # Es falsa
        fi
    fi
    
    return 1  # Imagen legítima
}

################################################################################
# FUNCIÓN: Escanear directorio /img/ en busca de imágenes falsas
################################################################################
scan_img_directory() {
    local img_dir="$PRESTASHOP_ROOT/img"
    
    if [ ! -d "$img_dir" ]; then
        log_message "WARNING" "Directorio /img no encontrado: $img_dir"
        return 1
    fi
    
    echo -e "${BLUE}ℹ${NC} Escaneando directorio /img/ (no recursivo)..."
    log_message "INFO" "Iniciando escaneo de /img/"
    
    local count=0
    # Escanear solo archivos en /img (no subdirectorios)
    for file in "$img_dir"/*; do
        # Saltar si es directorio
        [ -d "$file" ] && continue
        
        # Saltar archivos index.php legítimos
        if [ "$(basename "$file")" = "index.php" ]; then
            continue
        fi
        
        if is_fake_image "$file"; then
            local filename=$(basename "$file")
            echo -e "${RED}⚠${NC} MALWARE DETECTADO: $filename"
            log_message "ALERT" "Malware detectado en img: $file"
            INFECTION_DETECTED=1
            
            # Crear backup antes de eliminar
            local timestamp=$(date '+%Y%m%d_%H%M%S')
            local backup_path="$BACKUP_DIR/${filename}.malware.${timestamp}"
            cp "$file" "$backup_path" 2>/dev/null
            
            # Eliminar archivo malicioso
            rm -f "$file"
            if [ $? -eq 0 ]; then
                echo -e "${GREEN}✓${NC} Eliminado: $filename"
                log_message "SUCCESS" "Malware eliminado: $file (backup: $backup_path)"
                DELETED_MALWARE=$((DELETED_MALWARE + 1))
                count=$((count + 1))
            else
                echo -e "${RED}✗${NC} Error al eliminar: $filename"
                log_message "ERROR" "No se pudo eliminar: $file"
            fi
        fi
    done
    
    if [ $count -eq 0 ]; then
        echo -e "${GREEN}✓${NC} Directorio /img/ limpio"
        log_message "INFO" "Escaneo de /img/ completado: 0 malware encontrado"
    else
        log_message "SUCCESS" "Escaneo de /img/ completado: $count archivos maliciosos eliminados"
    fi
}

################################################################################
# FUNCIÓN: Enviar email de notificación
################################################################################
send_email_notification() {
    local subject=$1
    local body=$2
    
    if command -v mail >/dev/null 2>&1; then
        echo -e "$body" | mail -s "$subject" "$EMAIL_ALERTS"
        log_message "INFO" "Email enviado a: $EMAIL_ALERTS"
    elif command -v sendmail >/dev/null 2>&1; then
        echo -e "Subject: $subject\n\n$body" | sendmail "$EMAIL_ALERTS"
        log_message "INFO" "Email enviado via sendmail a: $EMAIL_ALERTS"
    else
        log_message "WARNING" "No se pudo enviar email: comando mail/sendmail no disponible"
    fi
}

################################################################################
# FUNCIÓN PRINCIPAL
################################################################################
main() {
    echo ""
    echo "════════════════════════════════════════════════════════════"
    echo "  PrestaShop Antimalware Protection - Escaneo Iniciado"
    echo "  $(date '+%Y-%m-%d %H:%M:%S')"
    echo "════════════════════════════════════════════════════════════"
    echo ""
    
    # Inicializar log
    init_log
    log_message "INFO" "=== Escaneo iniciado ==="
    
    # Verificar que el directorio de PrestaShop existe
    if [ ! -d "$PRESTASHOP_ROOT" ]; then
        echo -e "${RED}✗${NC} Error: Directorio de PrestaShop no encontrado: $PRESTASHOP_ROOT"
        log_message "ERROR" "Directorio no encontrado: $PRESTASHOP_ROOT"
        exit 1
    fi
    
    cd "$PRESTASHOP_ROOT" || exit 1
    
    # 1. VERIFICAR Controller.php
    echo -e "${BLUE}[1/4]${NC} Verificando Controller.php..."
    check_and_restore_php_file \
        "$PRESTASHOP_ROOT/classes/controller/Controller.php" \
        "$CLEAN_CONTROLLER_URL"
    
    # 2. VERIFICAR FrontController.php
    echo -e "${BLUE}[2/4]${NC} Verificando FrontController.php..."
    check_and_restore_php_file \
        "$PRESTASHOP_ROOT/classes/controller/FrontController.php" \
        "$CLEAN_FRONTCONTROLLER_URL"
    
    # 3. VERIFICAR AdminLoginController.php
    echo -e "${BLUE}[3/4]${NC} Verificando AdminLoginController.php..."
    check_and_restore_php_file \
        "$PRESTASHOP_ROOT/controllers/admin/AdminLoginController.php" \
        "$CLEAN_ADMINLOGIN_URL"
    
    # 4. ESCANEAR /img/ en busca de imágenes falsas
    echo -e "${BLUE}[4/4]${NC} Escaneando directorio /img/..."
    scan_img_directory
    
    # Resumen
    echo ""
    echo "════════════════════════════════════════════════════════════"
    echo "  RESUMEN DEL ESCANEO"
    echo "════════════════════════════════════════════════════════════"
    
    if [ $INFECTION_DETECTED -eq 0 ]; then
        echo -e "${GREEN}✓ SISTEMA LIMPIO${NC}"
        echo "  No se detectó malware"
        log_message "INFO" "Escaneo completado: Sistema limpio"
        
        if [ "$SEND_EMAIL_ON_CLEAN" = "yes" ]; then
            send_email_notification \
                "PrestaShop: Sistema Limpio" \
                "Escaneo completado sin detectar infecciones.\n\nFecha: $(date)"
        fi
    else
        echo -e "${RED}⚠ INFECCIÓN DETECTADA Y LIMPIADA${NC}"
        echo "  Archivos PHP infectados: $INFECTED_FILES"
        echo "  Archivos PHP restaurados: $RESTORED_FILES"
        echo "  Archivos malware eliminados: $DELETED_MALWARE"
        echo ""
        echo "  Los archivos infectados han sido respaldados en:"
        echo "  $BACKUP_DIR"
        
        log_message "ALERT" "Escaneo completado: Infección detectada y limpiada"
        log_message "STATS" "PHP infectados: $INFECTED_FILES | Restaurados: $RESTORED_FILES | Malware eliminado: $DELETED_MALWARE"
        
        if [ "$SEND_EMAIL_ON_INFECTION" = "yes" ]; then
            send_email_notification \
                "⚠ PrestaShop: INFECCIÓN DETECTADA Y LIMPIADA" \
                "Se ha detectado y eliminado malware de tu instalación de PrestaShop.\n\nDetalles:\n- Archivos PHP infectados: $INFECTED_FILES\n- Archivos PHP restaurados: $RESTORED_FILES\n- Malware eliminado: $DELETED_MALWARE\n\nBackups guardados en: $BACKUP_DIR\n\nFecha: $(date)\n\nRevisa el log completo en: $LOG_FILE"
        fi
    fi
    
    echo "════════════════════════════════════════════════════════════"
    echo ""
    
    log_message "INFO" "=== Escaneo finalizado ==="
}

# Ejecutar función principal
main

exit 0
